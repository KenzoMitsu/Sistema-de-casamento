<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Listagem de Usuários - Casamento Perfeito</title>
  <link rel="stylesheet" href="assets/css/listagem.css">
  <link rel="icon" href="assets/img/iconsite.png" type="image/x-icon">

  <!-- Sweet Alert -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

  <script src="api.js"></script>
</head>

<body style="background: url('assets/img/fundo-alianca.jpg')">

    <div id="modalCadastroOverlay" class="modal-cadastro-overlay hidden">
        <div id="modalCadastro" class="modal-cadastro-content">
            <button id="fecharModalCadastroBtn" class="close-btn-cadastro">&times;</button>
            <h3>Cadastrar Novo Usuário</h3>
            <form id="formCadastro">
                <div class="form-row">
                    <div class="form-group">
                        <label for="nome">Nome Completo</label>
                        <input type="text" id="nome" name="nome" placeholder="Digite o nome" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email" placeholder="Digite o email" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="senha">Senha</label>
                        <input type="password" id="senha" name="senha" placeholder="Crie uma senha forte" required>
                    </div>
                    <div class="form-group">
                        <label for="telefone">Telefone</label>
                        <input type="tel" id="telefone" name="telefone" placeholder="(XX) XXXXX-XXXX">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="data_nascimento">Data de Nascimento</label>
                        <input type="date" id="data_nascimento" name="data_nascimento">
                    </div>

                    <div class="form-group">
                        <label for="cep">CEP</label>
                        <input type="text" id="cep" name="cep" placeholder="Digite o CEP">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="cargo">Cargo</label>
                        <select id="cargo" name="cargo" required>
                            <option value="" disabled selected>Selecione um cargo</option>
                            <option value="1">Noivo</option>
                            <option value="2">Fornecedor</option>
                            <option value="3">Cerimonialista</option>
                            <option value="4">ADM</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="status">Status</label>
                        <select id="status" name="status">
                            <option value="A" selected>Ativo</option>
                            <option value="I">Inativo</option>
                        </select>
                    </div>
                </div>

                <div id="camposFornecedor" class="hidden">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="categoria">Categoria</label>
                            <select name="categoria" id="categoria" class="categoria" name="categoria" class="categoria">
                                <option selected disabled style="color: var(--cinza)">Categoria</option>
                                <option>Buffet</option>
                                <option>Confeiteiro</option>
                                <option>Alfaiataria</option>
                                <option>Maquiador/Cabeleireiro/Salão de Beleza</option>
                                <option>DJ/Cantor</option>
                                <option>Decoração</option>
                                <option>Fotógrafo</option>
                                <option>Transporte</option>
                                <option>Espaço para eventos</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="nome_marca">Nome da Marca/Empresa</label>
                            <input type="text" id="nome_marca" name="nome_marca" placeholder="Digite o nome da marca/empresa">
                        </div>
                    </div>
                </div>

                <button type="submit" class="submit-btn">Cadastrar Usuário</button>
            </form>
        </div>
    </div>

  <div class="overlay">
    <div class="modal">

      <img src="assets/img/logo-preta.png" alt="Logo Casamento Perfeito" class="logo-canto">
      
      <a href="home.html">
        <p class="close-btn">X</p>
      </a>

      <h2 class="titulo">Listagem de usuários</h2>

      <div class="container-principal">
        <button id="abrirModalCadastroBtn" class="botao-cadastrar">
            <img src="https://cdn-icons-png.flaticon.com/512/992/992651.png" alt="Ícone de adicionar">
            Cadastrar Novo Usuário
        </button>
      </div>

      <!-- Botões de filtro -->
      <div class="filtros">
        <button class="tipo active" data-cargo="todos" onclick="filtrarPorCargo('todos')">Todos</button>
        <button class="tipo" data-cargo="1" onclick="filtrarPorCargo(1)">Noivos</button>
        <button class="tipo" data-cargo="2" onclick="filtrarPorCargo(2)">Fornecedores</button>
        <button class="tipo" data-cargo="3" onclick="filtrarPorCargo(3)">Cerimonialistas</button>
        <button class="tipo" data-cargo="4" onclick="filtrarPorCargo(4)">ADMs</button>
      </div>
      <!-- aaaaa -->

      <div class="lista">
        <!-- Cabeçalho -->
        <div class="lista-header">
          <div class="header-usuario">Usuário:</div>
          <div class="header-tipo">Tipo:</div>
          <div class="header-acao"></div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    let todosUsuarios = []; // Armazena todos os usuários

    document.addEventListener("DOMContentLoaded", async () => {
        const token = localStorage.getItem('token'); 

        if (!token) {
            Swal.fire({
                icon: 'warning',
                title: 'Acesso Restrito',
                text: 'Você precisa estar logado para acessar esta página.',
                confirmButtonText: 'Entendi, ir para Login',
                allowOutsideClick: false,
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = 'login.html';
                }
            });
            return; 
        }

        await carregarUsuarios(token);
    });

    async function carregarUsuarios(token) {
        const lista = document.querySelector(".lista");

        const tiposMap = {
            1: "Noivo",
            2: "Fornecedor",
            3: "Cerimonialista",
            4: "ADM"
        };

        try {
            const response = await fetch(`${ipPython}/usuario`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.status === 401 || response.status === 403) {
                throw new Error("Token inválido ou expirado.");
            }
            
            if (!response.ok) {
                throw new Error("Erro HTTP: " + response.status);
            }

            const data = await response.json();
            todosUsuarios = data.usuarios; // Armazena todos os usuários

            renderizarUsuarios(todosUsuarios);

        } catch (error) {
            console.error("Erro ao carregar usuários:", error);
            
            const header = document.querySelector(".lista-header");
            lista.innerHTML = "";
            lista.appendChild(header);
            
            const erroMsg = document.createElement("div");
            erroMsg.textContent = "Erro ao carregar usuários.";
            erroMsg.style.padding = "20px";
            erroMsg.style.textAlign = "center";
            lista.appendChild(erroMsg);
        }
    }

    function renderizarUsuarios(usuarios) {
        const lista = document.querySelector(".lista");
        const tiposMap = {
            1: "Noivo",
            2: "Fornecedor",
            3: "Cerimonialista",
            4: "ADM"
        };

        const header = document.querySelector(".lista-header");
        lista.innerHTML = "";
        lista.appendChild(header);

        if (usuarios.length === 0) {
            const msgVazia = document.createElement("div");
            msgVazia.textContent = "Nenhum usuário encontrado.";
            msgVazia.style.padding = "20px";
            msgVazia.style.textAlign = "center";
            msgVazia.style.color = "#666";
            lista.appendChild(msgVazia);
            return;
        }

        usuarios.forEach(u => {
            const tipoNome = tiposMap[u.cargo] || "Outro"; 
            const item = document.createElement("div");
            item.classList.add("item");
            item.innerHTML = `
                <a href="mailto:${u.email}">${u.email}</a>
                <span class="tipo-label">${tipoNome}</span>
                <button class="editar-btn" onclick="abrirEdicao(${u.id_usuario})">
                    <img src="https://cdn-icons-png.flaticon.com/512/1159/1159633.png" alt="editar">
                </button>
            `;
            lista.appendChild(item);
        });
    }

    function filtrarPorCargo(cargo) {
        // Remove active de todos os botões
        document.querySelectorAll('.tipo').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Adiciona active no botão clicado
        const btnClicado = document.querySelector(`[data-cargo="${cargo}"]`);
        if (btnClicado) {
            btnClicado.classList.add('active');
        }

        // Filtra os usuários
        let usuariosFiltrados;
        if (cargo === 'todos') {
            usuariosFiltrados = todosUsuarios;
        } else {
            usuariosFiltrados = todosUsuarios.filter(u => u.cargo == cargo);
        }

        renderizarUsuarios(usuariosFiltrados);
    }

    function abrirEdicao(idUsuario) {
        if (idUsuario) {
            window.location.href = `edicao_usuarios_adm.html?id=${idUsuario}`;
        } else {
            console.error('ID do usuário não encontrado');
        }
    }

    // Seleciona os elementos da nova modal
    const abrirModalBtn = document.getElementById('abrirModalCadastroBtn');
    const fecharModalBtn = document.getElementById('fecharModalCadastroBtn');
    const modalOverlay = document.getElementById('modalCadastroOverlay');
    const formCadastro = document.getElementById('formCadastro');
    const cargoSelect = document.getElementById('cargo');
    const camposFornecedor = document.getElementById('camposFornecedor');

    // Funções para abrir e fechar a modal
    const abrirModalCadastro = () => modalOverlay.classList.remove('hidden');
    const fecharModalCadastro = () => modalOverlay.classList.add('hidden');

    // Eventos para abrir e fechar a modal
    abrirModalBtn.addEventListener('click', abrirModalCadastro);
    fecharModalBtn.addEventListener('click', fecharModalCadastro);

    // Fecha a modal se clicar fora dela (no overlay)
    modalOverlay.addEventListener('click', (e) => {
        if (e.target === modalOverlay) {
            fecharModalCadastro();
        }
    });

    // Mostra/oculta campos de fornecedor com base no cargo selecionado
    cargoSelect.addEventListener('change', () => {
        // Usamos '2' como string pois o valor do <option> é uma string
        if (cargoSelect.value === '2') {
            camposFornecedor.classList.remove('hidden');
            // Torna os campos de fornecedor obrigatórios
            document.getElementById('categoria').required = true;
            document.getElementById('nome_marca').required = true;
        } else {
            camposFornecedor.classList.add('hidden');
            // Remove a obrigatoriedade
            document.getElementById('categoria').required = false;
            document.getElementById('nome_marca').required = false;
        }
    });

    // Lógica para enviar o formulário de cadastro
    formCadastro.addEventListener('submit', async (e) => {
        e.preventDefault(); // Previne o recarregamento da página

        const token = localStorage.getItem('token');
        if (!token) {
            Swal.fire('Erro', 'Token de autenticação não encontrado. Faça login novamente.', 'error');
            return;
        }

        // Coleta os dados do formulário
        const formData = new FormData(formCadastro);
        const data = Object.fromEntries(formData.entries());

        // Formatação da data de nascimento para "dd-mm-aaaa"
        if (data.data_nascimento) { // Verifica se uma data foi selecionada
            const parts = data.data_nascimento.split('-'); // Converte "AAAA-MM-DD" para ["AAAA", "MM", "DD"]
            data.data_nascimento = `${parts[2]}-${parts[1]}-${parts[0]}`; // Remonta como "dd-mm-aaaa"
        }   

        // Se o cargo não for 'Fornecedor', remove os campos específicos para não enviá-los
        if (data.cargo !== '2') {
            delete data.categoria;
            delete data.nome_marca;
        }
        
        try {
            const response = await fetch(`${ipPython}/admin/cadastrar-usuario`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (!response.ok) {
                // Se a resposta não for OK, lança um erro com a mensagem da API
                throw new Error(result.error || `Erro ${response.status}`);
            }

            // Sucesso!
            Swal.fire({
                icon: 'success',
                title: 'Usuário Cadastrado!',
                text: result.message || 'O novo usuário foi criado com sucesso.',
                timer: 2000,
                showConfirmButton: false
            });

            fecharModalCadastro(); // Fecha a modal
            formCadastro.reset(); // Limpa o formulário
            camposFornecedor.classList.add('hidden'); // Garante que os campos de fornecedor fiquem ocultos
            
            await carregarUsuarios(token); // Atualiza a lista de usuários na página

        } catch (error) {
            console.error('Erro ao cadastrar usuário:', error);
            Swal.fire({
                icon: 'error',
                title: 'Ops... Algo deu errado',
                text: error.message
            });
        }
    });
  </script>

</body>
</html>