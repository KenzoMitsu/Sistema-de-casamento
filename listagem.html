<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Listagem de Usuários - Casamento Perfeito</title>
  <link rel="stylesheet" href="assets/css/listagem.css">
  <link rel="icon" href="assets/img/iconsite.png" type="image/x-icon">

  <!-- Sweet Alert -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

  <script src="api.js"></script>
</head>

<body style="background: url('assets/img/fundo-alianca.jpg')">
  <div class="overlay">
    <div class="modal">
      <img src="assets/img/logo-preta.png" alt="Logo Casamento Perfeito" class="logo-canto">
      <a href="home.html">
                    <p class="close-btn">X</p>
                </a>
      <h2 class="titulo">Listagem de usuários</h2>

      <div class="lista">
        <!-- Cabeçalho -->
        <div class="lista-header">
          <div class="header-usuario">Usuário:</div>
          <div class="header-tipo">Tipo:</div>
          <div class="header-acao"></div>
        </div>

        <!-- Itens -->
        <div class="item">
          <a href="mailto:davi@gmail.com">davi@gmail.com</a>
          <span class="tipo">Fornecedores</span>
          <button class="editar-btn"  onclick="window.location.href='edicao_usuarios_adm.html'">
            <img src="https://cdn-icons-png.flaticon.com/512/1159/1159633.png" alt="editar">
          </button>
        </div>

        <div class="item">
          <a href="mailto:julia@gmail.com">julia@gmail.com</a>
          <span class="tipo">Cerimonialista</span>
          <button class="editar-btn">
            <img src="https://cdn-icons-png.flaticon.com/512/1159/1159633.png" alt="editar">
          </button>
        </div>

        <div class="item">
          <a href="mailto:sthefany@gmail.com">sthefany@gmail.com</a>
          <span class="tipo">Noivo(a)</span>
          <button class="editar-btn">
            <img src="https://cdn-icons-png.flaticon.com/512/1159/1159633.png" alt="editar">
          </button>
        </div>

        <div class="item">
          <a href="mailto:kenzo@gmail.com">kenzo@gmail.com</a>
          <span class="tipo">Cerimonialista</span>
          <button class="editar-btn">
            <img src="https://cdn-icons-png.flaticon.com/512/1159/1159633.png" alt="editar">
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    document.addEventListener("DOMContentLoaded", async () => {
        const token = localStorage.getItem('token'); 

        if (!token) {
            // A biblioteca Swal precisa ser importada no <head> para funcionar
            Swal.fire({
                icon: 'warning',
                title: 'Acesso Restrito',
                text: 'Você precisa estar logado para acessar esta página.',
                confirmButtonText: 'Entendi, ir para Login',
                allowOutsideClick: false, // Impede que o usuário feche o modal clicando fora
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = 'login.html'; // Redireciona para o login
                }
            });

            return; 
        }

        const lista = document.querySelector(".lista");

        const tiposMap = {
            1: "Noivo",
            2: "Fornecedor",
            3: "Cerimonialista"
        };

        try {
            // Certifique-se de que a variável 'ipPython' está definida (provavelmente em api.js)
            const response = await fetch(`${ipPython}/usuario`, {
                headers: {
                    'Authorization': `Bearer ${token}` // É uma boa prática enviar o token para a API
                }
            });

            if (response.status === 401 || response.status === 403) {
                // Se o token for inválido, redireciona também
                throw new Error("Token inválido ou expirado.");
            }
            
            if (!response.ok) {
                throw new Error("Erro HTTP: " + response.status);
            }

            const data = await response.json();

            const header = document.querySelector(".lista-header");
            lista.innerHTML = "";
            lista.appendChild(header);

            data.usuarios.forEach(u => {
                const tipoNome = tiposMap[u.cargo] || "Adm"; 
                const item = document.createElement("div");
                item.classList.add("item");
                item.innerHTML = `
                    <a href="mailto:${u.email}">${u.email}</a>
                    <span class="tipo">${tipoNome}</span>
                    <button class="editar-btn" onclick="window.location.href='edicao_usuarios_adm.html?id=${u.id}'">
                        <img src="https://cdn-icons-png.flaticon.com/512/1159/1159633.png" alt="editar">
                    </button>
                `;
                lista.appendChild(item);
            });

        } catch (error) {
            console.error("Erro ao carregar usuários:", error);
            
            // Se o erro for de token inválido, redirecionar para o login
            if (error.message.includes("Token")) {
                localStorage.removeItem('token'); // Limpa o token inválido
                window.location.href = 'login.html';
            } else {
                const erroMsg = document.createElement("div");
                erroMsg.textContent = "Erro ao carregar usuários.";
                lista.appendChild(erroMsg);
            }
        }
    });
  </script>

</body>
</html>



