<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gerenciamento de Fornecedores - Casamento Perfeito</title>
  <link rel="stylesheet" href="assets/css/gerenciamento_festa.css">
  <link rel="icon" href="assets/img/iconsite.png" type="image/x-icon">
  
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="/js/modal_perfil.js"></script>
  <script src="/js/api.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Luxurious+Script&family=Old+Standard+TT:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Ledger&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,100;0,300;0,400;0,700;0,900;1,100;1,300;1,400;1,700;1,900&display=swap" rel="stylesheet">

  <style>
    /* Necessário para posicionar o selo relativo ao card */
    .card {
      position: relative;
      transition: all 0.3s ease;
    }

    /* Estilo do Card quando Completo (borda verde e fundo levemente verde) */
    .card.completed {
      border: 2px solid #28a745;
      background-color: #f0fff4;
    }

    /* O Selo de Confere (Checkmark) */
    .status-badge {
      position: absolute;
      top: -10px;
      right: -10px;
      background-color: #28a745; /* Verde */
      color: white;
      width: 35px;
      height: 35px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      z-index: 10;
      cursor: default;
    }
  </style>
</head>

<body>
  <section class="hero-section">
    <header class="header">
      <div class="header-container">
        <a href="home.html" class="logo">
          <img src="assets/img/logo-branca.png" alt="Casamento Perfeito Logo" class="logo-img">
        </a>

        <nav class="navbar">
          <ul>
            <li><a href="home.html">Home</a></li>
            <li><a href="sobre_nos.html">Sobre Nós</a></li>
            <li><a href="contato.html">Contato</a></li>
            <li><a id="profileLink" href="#"><img src="assets/img/perfil.png" alt="Ícone de Perfil" class="profile-icon"></a></li>
          </ul>
        </nav>
      </div>
      
      <script src="assets/js/main.js"></script>
    </header>
  </section>

  <div id="logoutModal" class="modal-overlay">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h2>Opções da Conta</h2>
      <div id="modalOptionsContainer" class="modal-options-container">
      </div>
    </div>
  </div>

  <section class="banner">
    <div class="banner-img">
      <img src="assets/img/homememulheraliança.png" alt="Banner Casamento">
    </div>
    <div class="texto-banner">
      <h2 class="titulo-haha">Agendamento de <span><br>Fornecedores e Cerimonialistas</span></h2>
      <p>Respectivos <strong>fornecedores</strong> do seu trabalho</p>
    </div>
  </section>

  <div class="botao">
    <button id="add-fornecedor-btn">+ Convidar novo fornecedor</button>
  </div>

  <section class="cards" id="cards-container">
    </section>

  <div id="modal-fornecedores" class="modal-overlay">
    <div class="modal-conteudo">
      <span id="close-modal-btn" class="close-button">&times;</span>
      <h2>Adicionar Novo Serviço</h2>
      <div id="modal-services-list" class="services-list-container">
      </div>
    </div>
  </div>

  <footer class="footer">
    <div class="footer-contact-bar">
      <div class="footer-container">
        <p class="contato">Entre em contato conosco</p>
        <div class="social-icons">
             <a href="#" aria-label="Instagram"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M7.8,2H16.2C19.4,2 22,4.6 22,7.8V16.2A5.8,5.8 0 0,1 16.2,22H7.8C4.6,22 2,19.4 2,16.2V7.8A5.8,5.8 0 0,1 7.8,2M7.6,4A3.6,3.6 0 0,0 4,7.6V16.4C4,18.39 5.61,20 7.6,20H16.4A3.6,3.6 0 0,0 20,16.4V7.6C20,5.61 18.39,4 16.4,4H7.6M17.25,5.5A1.25,1.25 0 0,1 18.5,6.75A1.25,1.25 0 0,1 17.25,8A1.25,1.25 0 0,1 16,6.75A1.25,1.25 0 0,1 17.25,5.5M12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9Z" /></svg></a>
             <a href="#" aria-label="LinkedIn"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M19,3A2,2 0 0,1 21,5V19A2,2 0 0,1 19,21H5A2,2 0 0,1 3,19V5A2,2 0 0,1 5,3H19M18.5,18.5V13.2A3.26,3.26 0 0,0 15.24,9.94C14.39,9.94 13.4,10.43 13,11.1V10.13H10.13V18.5H13V13.57C13,12.37 13.74,11.54 14.83,11.54C15.92,11.54 16.28,12.38 16.28,13.57V18.5H18.5M6.88,8.56A1.68,1.68 0 0,0 8.56,6.88C8.56,6 7.78,5.2 6.88,5.2C6,5.2 5.2,6 5.2,6.88A1.68,1.68 0 0,0 6.88,8.56M8.27,18.5V10.13H5.5V18.5H8.27Z" /></svg></a>
        </div>
      </div>
    </div>
    <div class="footer-main">
        <div class="footer-container">
            <div class="footer-logo"><img src="assets/img/logo-branca.png" alt="Casamento Perfeito Logo"></div>
        </div>
    </div>
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', function () {

      // --- 1. Obter IDs e Token ---
      const urlParams = new URLSearchParams(window.location.search);
      const id_festa = urlParams.get('id_festa');
      const token = localStorage.getItem('token');

      // Função Auxiliar para decodificar o JWT
      function parseJwt(token) {
        try {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        } catch (e) {
            return null;
        }
      }

      // --- 2. Verificar Autenticação e Cargo ---
      if (!token) {
        Swal.fire('Não autenticado', 'Você precisa estar logado.', 'warning')
          .then(() => window.location.href = 'login.html');
        return;
      }
      
      const payload = parseJwt(token);
      // Verifica se o cargo é 3 (Cerimonialista)
      const cargo = payload ? payload.cargo : null;
      const isCerimonialista = (cargo == 3);

      if (!id_festa) {
        Swal.fire('Erro', 'Nenhuma festa selecionada.', 'error')
          .then(() => window.location.href = 'minhas_festas.html');
        return;
      }

      // --- Elementos do DOM ---
      const cardsContainer = document.getElementById('cards-container');
      const addBtn = document.getElementById('add-fornecedor-btn');
      const modal = document.getElementById('modal-fornecedores');
      const closeModalBtn = document.getElementById('close-modal-btn');
      const modalServicesList = document.getElementById('modal-services-list');


      // --- 3. Função: Carregar Serviços ---
      async function carregarServicosAssociados() {
        const url = ipPython + `/relacao/festa/${id_festa}`;

        try {
          const response = await fetch(url, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          const resultado = await response.json();
          cardsContainer.innerHTML = '';

          if (!Array.isArray(resultado) || resultado.length === 0) {
            cardsContainer.innerHTML = '<p class="mensagem-vazio">Nenhum fornecedor ou cerimonialista foi convidado ainda.</p>';
          } else {
            resultado.forEach(relacao => {
              const servico = relacao.servico;
              const usuario = relacao.usuario;

              const tituloUsuario = usuario.categoria && usuario.categoria.toLowerCase() === "cerimonialista"
                ? "Cerimonialista"
                : "Fornecedor";

              // 3.1. Tratamento da Situação
              const isCompleto = relacao.situacao === 'C';
              
              // Define o selo (Checkmark) se estiver completo
              const badgeHtml = isCompleto 
                ? `<div class="status-badge" title="Tarefa Concluída">✔</div>` 
                : '';

              // Define classes e textos baseados na situação
              const cardClass = isCompleto ? 'card completed' : 'card';
              const btnTexto = isCompleto ? 'Reabrir Tarefa' : 'Concluir Tarefa';
              const btnClassExtra = isCompleto ? 'reabrir' : '';

              // --- LÓGICA DE EXIBIÇÃO DO BOTÃO EXCLUIR ---
              let htmlBotaoExcluir = '';
              if (!isCerimonialista) {
                  // Se NÃO for cerimonialista, exibe o botão
                  htmlBotaoExcluir = `
                    <button class="btn-delete-relacao" 
                        data-id-relacao="${relacao.id_relacao}"
                        style="background-color: #d33; color: white; padding: 8px 12px; border:none; border-radius:4px; cursor:pointer;">
                        Excluir
                    </button>
                  `;
              }

              const cardHtml = `
                <div class="${cardClass}">
                  ${badgeHtml} <img src="${ipPython}/static/uploads/Servicos/${servico.id_servico}.jpeg" alt="${servico.nome}" onerror="this.src='assets/img/default-service.png'">
                  <h3>${servico.nome ? servico.nome.toUpperCase() : 'NOME SERVIÇO'}</h3>
                  <p><strong>Tarefa vinculada:</strong> ${relacao.nome || 'Sem nome'}</p>
                  <p>${servico.descricao || 'Descrição do serviço.'}</p>
                  <p><strong>Categoria:</strong> ${servico.categoria || '-'}</p>
                  <p><strong>${tituloUsuario}:</strong> ${usuario.nome || '-'}</p>
                  <p><strong>Email:</strong> ${usuario.email || '-'}</p>
                  
                  <div class="actions-container">
                    <button class="btn-toggle-status ${btnClassExtra}" 
                        data-id-relacao="${relacao.id_relacao}" 
                        data-situacao-atual="${relacao.situacao || 'I'}">
                        ${btnTexto}
                    </button>

                    ${htmlBotaoExcluir} </div>
                </div>
              `;
              cardsContainer.innerHTML += cardHtml;
            });
          }
        } catch (error) {
          cardsContainer.innerHTML = `<p class="mensagem-vazio" style="color: red;">Erro ao carregar serviços: ${error.message}</p>`;
        }
      }

      // --- 4. Função: Alternar Situação (PUT) ---
      async function alternarSituacaoTarefa(idRelacao, situacaoAtual) {
        const novaSituacao = situacaoAtual === 'C' ? 'I' : 'C';
        const url = ipPython + `/relacao/${idRelacao}`;

        try {
            const response = await fetch(url, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    situacao: novaSituacao 
                })
            });

            const resultado = await response.json();

            if (!response.ok) {
                throw new Error(resultado.error || 'Erro ao atualizar situação.');
            }

            // Sucesso visual
            const msg = novaSituacao === 'C' ? 'Tarefa Concluída!' : 'Tarefa Reaberta!';
            const icon = novaSituacao === 'C' ? 'success' : 'info';
            
            Swal.fire({
                title: msg,
                icon: icon,
                timer: 1500,
                showConfirmButton: false
            });

            carregarServicosAssociados();

        } catch (error) {
            Swal.fire('Erro', error.message, 'error');
        }
      }

      // --- 5. Funções Auxiliares (Modal e Adicionar) ---
      async function abrirModalFornecedores() {
        modal.style.display = 'flex';
        modalServicesList.innerHTML = '<p>Carregando serviços...</p>';
        const url = ipPython + '/servico';
        try {
          const response = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
          const resultado = await response.json();
          modalServicesList.innerHTML = '';
          if (!resultado.servicos || resultado.servicos.length === 0) {
            modalServicesList.innerHTML = '<p>Nenhum serviço disponível no sistema.</p>';
            return;
          }
          resultado.servicos.forEach(servico => {
            const itemHtml = `
            <div class="service-item">
              <span><strong>${servico.nome}</strong> (${servico.categoria})</span>
              <button class="btn-add-service" data-id-servico="${servico.id_servico}" data-nome-servico="${servico.nome}">ADD</button>
            </div>
          `;
            modalServicesList.innerHTML += itemHtml;
          });
        } catch (error) {
          modalServicesList.innerHTML = `<p style="color: red;">Erro ao carregar: ${error.message}</p>`;
        }
      }

      async function adicionarServicoAFesta(id_servico, nome_tarefa) {
        const url = ipPython + '/relacao';
        try {
          const response = await fetch(url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ id_servico: id_servico, id_festa: id_festa, nome: nome_tarefa })
          });
          const resultado = await response.json();
          if (!response.ok) {
            if (resultado.error && (resultado.error.includes("UNIQUE") || resultado.error.includes("já existe"))) {
              throw new Error("Este fornecedor já foi adicionado a esta festa.");
            }
            throw new Error(resultado.error || 'Erro ao adicionar.');
          }
          Swal.fire('Sucesso!', 'Fornecedor e Tarefa adicionados!', 'success');
          modal.style.display = 'none';
          carregarServicosAssociados(); 
        } catch (error) {
          Swal.fire('Erro ao adicionar', error.message, 'info');
        }
      }

      // --- 6. Event Listeners ---
      addBtn.addEventListener('click', abrirModalFornecedores);

      closeModalBtn.addEventListener('click', () => { modal.style.display = 'none'; });
      window.addEventListener('click', (e) => { if (e.target == modal) modal.style.display = 'none'; });

      // Listener Modal ADD
      modalServicesList.addEventListener('click', async function (e) {
        if (e.target && e.target.classList.contains('btn-add-service')) {
          const btn = e.target;
          const { value: nomeTarefa } = await Swal.fire({
            title: 'Nova Tarefa',
            text: `Defina um nome para a tarefa vinculada ao serviço: ${btn.dataset.nomeServico}`,
            input: 'text',
            inputLabel: 'Nome da Tarefa',
            inputPlaceholder: 'Ex: Reunião inicial, Pagamento sinal...',
            showCancelButton: true,
            confirmButtonText: 'Adicionar',
            cancelButtonText: 'Cancelar',
            inputValidator: (value) => { if (!value) return 'Você precisa digitar um nome para a tarefa!'; }
          });
          if (nomeTarefa) {
            btn.disabled = true;
            btn.textContent = '...';
            await adicionarServicoAFesta(btn.dataset.idServico, nomeTarefa);
            btn.disabled = false;
            btn.textContent = 'ADD';
          }
        }
      });

      // Listener Global nos Cards (Delegação de Eventos)
      cardsContainer.addEventListener('click', async (e) => {
        
        // BOTÃO EXCLUIR
        if (e.target.classList.contains('btn-delete-relacao')) {
          const idRelacao = e.target.dataset.idRelacao;
          const confirma = await Swal.fire({
            title: 'Tem certeza?',
            text: "Deseja cancelar essa relação?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Sim, cancelar!',
            cancelButtonText: 'Não',
          });
          if (confirma.isConfirmed) {
            try {
              const response = await fetch(ipPython + `/relacao/${idRelacao}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
              });
              const result = await response.json();
              if (!response.ok) throw new Error(result.error || 'Erro ao cancelar relação');
              Swal.fire('Cancelada!', 'Relação cancelada com sucesso.', 'success');
              carregarServicosAssociados();
            } catch (error) {
              Swal.fire('Erro', error.message, 'error');
            }
          }
        }

        // BOTÃO CONCLUIR / REABRIR (NOVO)
        if (e.target.classList.contains('btn-toggle-status')) {
            const idRelacao = e.target.dataset.idRelacao;
            const situacaoAtual = e.target.dataset.situacaoAtual;
            await alternarSituacaoTarefa(idRelacao, situacaoAtual);
        }

      });

      // --- 7. Carga Inicial ---
      carregarServicosAssociados();
    });
  </script>

</body>
</html>