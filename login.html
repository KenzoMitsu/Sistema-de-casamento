<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login - Casamento Perfeito</title>
  <link rel="icon" href="assets/img/iconsite.png" type="image/x-icon">
  <link rel="stylesheet" href="assets/css/login.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Ledger&display=swap" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"
    integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
  <script src="api.js"></script>
</head>

<body>
    <main>
        <form class="principal">
            <div class="formulario">
                <h1 class="titulo">Login</h1>
                <img src="assets/img/logo-preta.png" alt="Logo Casamento Perfeito" class="logo-canto">
                <a href="index.html">
                    <p class="bot-fechar">X</p>
                </a>
                <input name="email" id="email" type="email" placeholder="E-mail" required />
                <div class="senha-container">
                    <input class="senha" type="password" placeholder="Senha" id="senha" name="senha">
                    <img id="toggleSenha" src="https://cdn-icons-png.flaticon.com/512/2767/2767146.png" alt="Mostrar senha">
                </div>
                <button type="submit" class="botao-login">Entrar</button>
                <p class="cadastro">Não possui uma conta? <a class="cadastro" href="cadastro.html">Cadastre-se</a></p>
            </div>
        </form>    
    </main>
</body>
<script>


        $("#toggleSenha").on("click", function () {
            let senhaInput = $("#senha");
            let icone = $("#toggleSenha");

            if (senhaInput.attr("type") === "password") {
                senhaInput.attr("type", "text");
                icone.attr("src", "https://cdn-icons-png.flaticon.com/512/2767/2767149.png");
            } else {
                senhaInput.attr("type", "password");
                icone.attr("src", "https://cdn-icons-png.flaticon.com/512/2767/2767146.png");
            }
        });

</script>

<script>
    $(document).ready(function() {

        $(".botao-login").on("click", function(e) {
            e.preventDefault();

            let email = $("#email").val().trim();
            let senha = $("#senha").val().trim();

            // Verificação de campos (corrigida, sem duplicar)
            if (!email || !senha) {
                Swal.fire({
                    title: "Erro!",
                    text: "Por favor, preencha todos os campos!",
                    icon: "error"
                });
                return;
            }

            // Apenas um objeto de dados
            let dados = JSON.stringify({
                email,
                senha
            });

            // Apenas UMA chamada AJAX
            $.ajax({
                method: "POST",
                url: ipPython + "/login", // Verifique se este IP ainda é válido
                contentType: "application/json",
                data: dados,
                success: function(retorno) {
                    console.log("Resposta do servidor:", retorno);

                    let token = retorno.token || null;
                    let usuario = retorno.usuario || {};

                    // Salva cada informação em um campo separado no localStorage
                    localStorage.setItem('token', token);
                    localStorage.setItem('id_usuario', usuario.id_usuario || '');
                    localStorage.setItem('nome', usuario.nome || '');
                    localStorage.setItem('email', usuario.email || '');
                    localStorage.setItem('telefone', usuario.telefone || '');
                    localStorage.setItem('data_nascimento', usuario.data_nascimento || '');
                    localStorage.setItem('cargo', usuario.cargo || '');
                    localStorage.setItem('categoria', usuario.categoria || '');
                    localStorage.setItem('nome_marca', usuario.nome_marca || '');

                    // Salva o objeto completo no localStorage como uma string JSON
                    localStorage.setItem("dados_usuario", JSON.stringify(usuario));

                    Swal.fire({
                        title: "Login bem-sucedido!",
                        icon: "success"
                    }).then(() => {
                        // Redireciona SEMPRE para home.html
                        window.location.href = "home.html";
                    });
                },
                error: function(retorno) {
                    console.log("Erro na requisição:", retorno);
                    Swal.fire({
                        title: "Erro!",
                        text: retorno.responseJSON?.error || "E-mail ou senha incorretos. Tente novamente.",
                        icon: "error"
                    });
                }
            });

        });

    });
</script>

</html>