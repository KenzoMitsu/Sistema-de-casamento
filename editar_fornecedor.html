<!DOCTYPE html>
<html lang="pt-br" dir="ltr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="assets/img/iconsite.png" type="image/x-icon">
    <link rel="stylesheet" href="assets/css/editar_fornecedor.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Ledger&display=swap" rel="stylesheet">
    <title>Edição de Fornecedor - Casamento Perfeito</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
    <script src="api.js"></script>
    </head>

    <body>
        <main>
            <div class="principal">
                <form id="editForm" class="formulario">
                    <h1 class="titulo">Edição de Fornecedor</h1>
                    <img src="assets/img/logo-preta.png" alt="Logo Casamento Perfeito" class="logo-canto">
                    <a href="home.html">
                        <p class="bot-fechar">X</p>
                    </a>


                    <input type="hidden" id="tipo" name="tipo" value="1">
                    <div class="cadastro-sec">
                        <div id="cadastro1" class="cadastro1">
                            <input class="nome" type="text" placeholder="Seu nome" id="nome" name="nome">
                            <input class="email" type="email" placeholder="E-mail" id="email" name="email">
                            <div class="senha-container">
                                </div>
                            <input class="nome-marca" type="text" placeholder="Nome da marca" id="nome_marca" name="nome_marca">
                        </div>
                        <div id="cadastro2" class="cadastro2">
                            <input class="telefone" type="tel" placeholder="Telefone" id="telefone" name="telefone">
                            <input class="data-nascimento" type="date" placeholder="Data de nascimento" id="data_nascimento" name="data_nascimento">
                            <input class="cep" type="text" placeholder="CEP" id="cep" name="cep">
                            <select name="categoria" id="categoria" class="categoria">
                                <option selected disabled>Categoria</option>
                                <option>Buffet</option>
                                <option>Confeiteiro</option>
                                <option>Alfaiataria</option>
                                <option>Maquiador/Cabeleireiro/Salão de Beleza</option>
                                <option>DJ/Cantor</option>
                                <option>Decoração</option>
                                <option>Fotógrafo</option>
                                <option>Transporte</option>
                                <option>Espaço para eventos</option>
                            </select>
                        </div>
                    </div>
                    <div class="sec-upload-box">
                        <label class="upload-box">
                            <span>Adicionar uma foto</span>
                            <input type="file" id="imagem" name="imagem" accept="image/*">
                        </label>
                    </div>
                    <button type="submit" class="botao-editar">Editar</button>
                </form>
            </div>
        </main>

        <script>
            $(document).ready(function () {
                // Aplicando máscaras aos campos
                $('#telefone').mask('(00) 00000-0000');
                $('#cep').mask('00000-000');

                const idUsuario = localStorage.getItem('id_usuario');
                const token = localStorage.getItem('token');

                // 1. VERIFICAR SE O USUÁRIO ESTÁ LOGADO
                if (!idUsuario || !token) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Acesso Negado',
                        text: 'Você precisa estar logado para editar o perfil.',
                        confirmButtonText: 'Ir para Login'
                    }).then(() => {
                        window.location.href = 'login.html';
                    });
                    return; // Para a execução do script
                }

                // EXIBIR OS DADOS DO FORNECEDOR
                // fornecedores retorna uma lista, então precisamos encontrar o usuário correto
                $.ajax({
                    url: ipPython + '/fornecedores',
                    method: 'GET',
                    dataType: 'json',
                    success: function (data) {
                        if (data.usuarios && data.usuarios.length > 0) {
                            const idUsuarioNumerico = parseInt(idUsuario, 10);
                            const fornecedor = data.usuarios.find(u => u.id_usuario === idUsuarioNumerico);

                            if (fornecedor) {
                                // Preenche os campos do formulário
                                $('#nome').val(fornecedor.nome);
                                $('#email').val(fornecedor.email);
                                $('#telefone').val(fornecedor.telefone);
                                $('#nome_marca').val(fornecedor.nome_marca);
                                $('#categoria').val(fornecedor.categoria);
                                $('#cep').val(fornecedor.cep);
                                
                                // A data vem como string, precisa ser formatada para o input type="date"
                                if (fornecedor.data_nascimento) {
                                    // Assume que o formato da API é 'Wed, 24 Jan 1990 00:00:00 GMT' ou similar
                                    const dataObj = new Date(fornecedor.data_nascimento);
                                    // Formata para 'YYYY-MM-DD'
                                    const dia = ('0' + dataObj.getDate()).slice(-2);
                                    const mes = ('0' + (dataObj.getMonth() + 1)).slice(-2);
                                    const ano = dataObj.getFullYear();
                                    $('#data_nascimento').val(`${ano}-${mes}-${dia}`);
                                }
                            } else {
                                Swal.fire('Erro', 'Fornecedor não encontrado na lista.', 'error');
                            }
                        } else {
                            Swal.fire('Aviso', 'Nenhum fornecedor encontrado na base de dados.', 'warning');
                        }
                    },
                    error: function () {
                        Swal.fire({
                            icon: 'error',
                            title: 'Oops...',
                            text: 'Não foi possível carregar suas informações. Tente novamente mais tarde.'
                        });
                    }
                });

                // 3. LIDAR COM O ENVIO DO FORMULÁRIO DE EDIÇÃO
                $('#editForm').on('submit', function (e) {
                    e.preventDefault(); // Impede o recarregamento da página

                    // Cria um objeto FormData para enviar os dados, incluindo a imagem
                    var formData = new FormData(this);
                    
                    //A API espera 'data_nascimento' no formato dd-mm-yyyy, então convertemos
                    const dataInput = $('#data_nascimento').val(); // Pega 'YYYY-MM-DD'
                    if (dataInput) {
                        const [ano, mes, dia] = dataInput.split('-');
                        formData.set('data_nascimento', `${dia}-${mes}-${ano}`); // Converte para 'DD-MM-YYYY'
                    }

                    $.ajax({
                        url: ipPython + `/usuarios/${idUsuario}`,
                        method: 'PUT',
                        data: formData,
                        processData: false, // Necessário para FormData
                        contentType: false,
                        success: function (response) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Sucesso!',
                                text: response.message || 'Perfil atualizado com sucesso!'
                            }).then(() => {
                                // Opcional: redirecionar para a página de perfil
                                window.location.href = 'editar_fornecedor.html';
                            });
                        },
                        error: function (xhr) {
                            const errorMsg = xhr.responseJSON ? xhr.responseJSON.error : 'Ocorreu um erro ao editar o perfil. Tente novamente.';
                            Swal.fire({
                                icon: 'error',
                                title: 'Erro na Edição',
                                text: errorMsg
                            });
                        }
                    });
                });
            });
        </script>
    </body>

</html>