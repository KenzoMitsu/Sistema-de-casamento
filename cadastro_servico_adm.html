<!DOCTYPE html>
<html lang="pt-br" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="assets/img/iconsite.png" type="image/x-icon">
    <link rel="stylesheet" href="assets/css/cadastro_servico_adm.css">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
        crossorigin="anonymous">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Ledger&display=swap" rel="stylesheet">
    <title>Cadastro de Serviço - Casamento Perfeito</title>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
            integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
    <script src="/js/api.js"></script>
</head>

<body style="background: url('assets/img/fundo-alianca.jpg')">

    <main>
        <div class="principal">
            <div class="formulario">
                <h1 class="titulo">Cadastrar Serviço</h1>
                <img src="assets/img/logo-preta.png" alt="Logo Casamento Perfeito" class="logo-canto">
                <a href="home.html"><p class="bot-fechar">X</p></a>

                <input type="hidden">

                <div class="cadastro-sec">
                    <div id="cadastro1" class="cadastro1">
                        <form>
                            <div class="sec-upload-box">
                                <label class="upload-box">
                                    <img src="assets/img/pasta.png" alt="Ícone pasta" class="foto-pasta">
                                    <span>Adicionar uma foto</span>
                                    <input type="file" name="foto" accept="image/*">
                                </label>
                            </div>
                        </form>
                    </div>

                    <div id="cadastro2" class="cadastro2">
                        <input class="nome_servico" type="text" placeholder="Nome do serviço" id="nome_servico" name="nome_servico">
                        <input class="valor" type="number" placeholder="Valor" id="valor" name="valor">

                        <select class="categoria" id="categoria" name="categoria" required>
                            <option value="">Carregando categorias...</option>
                        </select>
                        <textarea class="descricao" type="text" placeholder="Descrição" id="descricao" name="descricao"></textarea>
                    </div>
                </div>

                <button type="submit" class="botao-cadastrar">Cadastrar</button>
            </div>
        </div>
    </main>

</body>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const botaoCadastrar = document.querySelector(".botao-cadastrar");
            const fotoInput = document.querySelector('input[name="foto"]');
            const fotoPreview = document.querySelector('.foto-pasta');
            const labelText = document.querySelector('.upload-box span');

            // === Pré-visualização da imagem antes de enviar ===
            fotoInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        fotoPreview.src = e.target.result;
                        labelText.textContent = "Alterar foto";
                        fotoPreview.style.border = "1px solid #ccc";
                    };
                    reader.readAsDataURL(file);
                } else {
                    fotoPreview.src = "assets/img/pasta.png";
                    labelText.textContent = "Adicionar uma foto";
                    fotoPreview.style.border = "none";
                }
            });

            // Mapeamento de categorias de fornecedor para subcategorias de serviço
            const servico_categorias = {
                "Buffet": ["Café da Manhã", "Almoço", "Jantar", "Churrasco", "Infantil", "Self-service"],
                "Confeiteiro": ["Confeitaria", "Confeitaria Artística", "Chocolataria", "Confeitaria Gourmet"],
                "Alfaiataria": ["Ternos", "Blazers", "Calças/Saias", "Vestidos", "Moderna/Slim", "Geral"],
                "Maquiador/Cabeleireiro/Salão de Beleza": ["Maquiagem", "Cortes Clássicos", "Escovista", "Cabelo da Noiva", "Manicure/Pedicure"],
                "DJ/Cantor": ["Música Clássica", "Música Romântica", "Trompetista", "Maestro", "Pianista", "Banda de Rock", "DJ Solo", "Cantor Solo"],
                "Decoração": ["Decoração"],
                "Fotógrafo": ["Fotografia", "Cabine Fotográfica", "Fotos de Casal", "Fotos de Ensaio", "Álbum"],
                "Transporte": ["Táxi", "Carro de Luxo", "Limousine"],
                "Espaço para eventos": ["Eventos Grandes", "Eventos Médios", "Eventos Pequenos"]
            };

            // Função para popular o select de categoria de serviço (usa jQuery)
            function populateServiceCategorySelect(fornecedorCategoria, currentCategoria = null) {
                const select = $('#categoria'); // Alvo é o <select> que adicionamos
                select.empty(); // Limpa opções existentes (ex: "Carregando...")

                // Verifica se a categoria do fornecedor existe no mapeamento
                if (!servico_categorias[fornecedorCategoria]) {
                    select.append('<option value="">Categoria de fornecedor inválida ou não encontrada</option>');
                    return;
                }

                // Adiciona uma opção padrão
                select.append('<option value="">Selecione uma categoria</option>');

                // Adiciona as opções baseadas na categoria do fornecedor
                servico_categorias[fornecedorCategoria].forEach(subcategoria => {
                    const option = $('<option></option>').val(subcategoria).text(subcategoria);
                    if (currentCategoria && subcategoria === currentCategoria) {
                        option.prop('selected', true); // Pré-seleciona a categoria atual (para edição)
                    }
                    select.append(option);
                });
            }

            // === Captura o ID do fornecedor da URL ===
            const urlParams = new URLSearchParams(window.location.search);
            const idFornecedor = urlParams.get('id');

            if (!idFornecedor) {
                Swal.fire({
                    icon: 'error',
                    title: 'Erro',
                    text: 'ID do fornecedor não encontrado na URL.'
                });
                return;
            }

            // === NOVA FUNÇÃO: Busca dados do fornecedor para popular o select ===
            async function loadFornecedorInfo(id) {
                const token = localStorage.getItem("token");
                if (!token) {
                    Swal.fire('Erro', 'Token não encontrado. Faça login.', 'error');
                    $('#categoria').empty().append('<option value="">Erro de autenticação</option>');
                    return;
                }

                try {
                    const myHeaders = new Headers();
                    myHeaders.append("Authorization", token);
                    
                    const requestOptions = {
                        method: "GET",
                        headers: myHeaders,
                        redirect: "follow"
                    };
                    
                    // Assumindo que a rota /usuario/<id> retorna os dados do usuário
                    const response = await fetch(`${ipPython}/usuario/${id}`, requestOptions);
                    const data = await response.json();

                    if (response.ok) {
                        // Assumindo que o objeto de usuário tem a 'categoria'
                        if (data.usuario && data.usuario.categoria) {
                            // Sucesso! Popula o select
                            populateServiceCategorySelect(data.usuario.categoria);
                        } else {
                            // Usuário não tem categoria ou a resposta é inesperada
                            $('#categoria').empty().append('<option value="">Fornecedor não possui categoria</option>');
                        }
                    } else {
                        // Erro da API (ex: 404, 401)
                        $('#categoria').empty().append('<option value="">Erro ao buscar fornecedor</option>');
                        console.error("Erro ao buscar dados do fornecedor:", data.error || data.mensagem);
                    }

                } catch (error) {
                    console.error("Erro de rede ao buscar fornecedor:", error);
                    $('#categoria').empty().append('<option value="">Erro de rede</option>');
                }
            }

            // Chama a função para carregar as categorias assim que a página carregar
            loadFornecedorInfo(idFornecedor);

            // ========================================================
            // == ⬆️ FIM DA LÓGICA DE CATEGORIA ⬆️ ==
            // ========================================================


            // === Cadastro do serviço (MODIFICADO) ===
            botaoCadastrar.addEventListener("click", async (e) => {
                e.preventDefault();

                const nomeServico = document.getElementById("nome_servico").value.trim();
                const valor = document.getElementById("valor").value.trim();
                const descricao = document.getElementById("descricao").value.trim();
                const categoria = document.getElementById("categoria").value.trim(); // <-- CAMPO NOVO

                // Validação atualizada
                if (!nomeServico || !valor || !descricao || !categoria) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Ops...',
                        text: 'Por favor, preencha todos os campos, incluindo a categoria!'
                    });
                    return;
                }

                if (!fotoInput.files[0]) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Ops...',
                        text: 'Por favor, adicione uma foto!'
                    });
                    return;
                }

                const token = localStorage.getItem("token");
                const myHeaders = new Headers();
                myHeaders.append("Authorization", token);

                const formdata = new FormData();
                formdata.append("id_usuario", idFornecedor);
                formdata.append("nome", nomeServico);
                formdata.append("descricao", descricao);
                formdata.append("valor", valor);
                formdata.append("categoria", categoria); // <-- VALOR NOVO ADICIONADO
                formdata.append("imagem", fotoInput.files[0]);

                const requestOptions = {
                    method: "POST",
                    headers: myHeaders,
                    body: formdata,
                    redirect: "follow"
                };

                try {
                    const response = await fetch(ipPython + "/servicoadm", requestOptions);
                    const data = await response.json();

                    if (response.ok) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Sucesso!',
                            text: 'Serviço cadastrado com sucesso!',
                            showConfirmButton: false,
                            timer: 1500
                        }).then(() => {
                            window.location.href = "home.html"; // Redireciona para a home
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Erro',
                            // Usa a mensagem de erro da API (seja 'error' ou 'mensagem')
                            text: data.error || data.mensagem || 'Ocorreu um erro ao cadastrar o serviço.'
                        });
                    }

                } catch (error) {
                    console.error(error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Erro',
                        text: 'Não foi possível conectar ao servidor.'
                    });
                }
            });
        });
    </script>

</html>
