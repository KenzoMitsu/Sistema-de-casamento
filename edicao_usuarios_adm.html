<!DOCTYPE html>
<html lang="pt-br" dir="ltr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="assets/img/iconsite.png" type="image/x-icon">
    <link rel="stylesheet" href="assets/css/edicao_usuarios_adm.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Ledger&display=swap" rel="stylesheet">
    <title>Edição de Usuários - Casamento Perfeito</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
    <script src="api.js"></script>

</head>

<body style="background: url('assets/img/fundo-alianca.jpg')">
    <main>
        <div class="principal">
            <div class="formulario">
                <h1 class="titulo">Edição de Usuários</h1>
                <img src="assets/img/logo-preta.png" alt="Logo Casamento Perfeito" class="logo-canto">
                <a href="listagem.html">
                    <p class="bot-fechar">X</p>
                </a>



                <input type="hidden" id="cargo" name="cargo" value="">
                <div class="cadastro-sec">
                    <div id="cadastro1" class="cadastro1">
                        <input class="nome" type="text" placeholder="Seu nome" id="nome" name="nome">
                        <input class="email" type="email" placeholder="E-mail" id="email" name="email">
                    </div>
                    <div id="cadastro2" class="cadastro2">
                        <input class="telefone" type="tel" placeholder="Telefone" id="telefone" name="telefone">
                        <input class="data-nascimento" type="date" placeholder="Data de nascimento" id="data-nascimento"
                            name="data-nascimento">
                        <input class="cep" type="text" placeholder="CEP" id="cep" name="cep">
                    </div>
                </div>

                <!-- Campos específicos para fornecedores (cargo = 2) -->
                <div id="campos-fornecedor" style="display: none;">
                    <input class="nome-marca" type="text" placeholder="Nome da marca *" id="nome-marca"
                        name="nome-marca">
                    <select name="categoria" id="categoria" class="categoria">
                        <option value="" selected disabled style="color: var(--cinza)">Categoria *</option>
                        <option>Buffet</option>
                        <option>Confeiteiro</option>
                        <option>Alfaiataria</option>
                        <option>Maquiador/Cabeleireiro/Salão de Beleza</option>
                        <option>DJ/Cantor</option>
                        <option>Decoração</option>
                        <option>Fotógrafo</option>
                        <option>Transporte</option>
                        <option>Espaço para eventos</option>
                    </select>
                </div>

                <!-- Botões de ação -->
                <div class="botoes-acoes">
                    <button type="submit" class="botao-editar">Editar</button>
                    <button type="button" class="botao-servico" id="btn-adicionar-servico"
                        style="display: none;">Adicionar Serviço</button>
                </div>
            </div>
        </div>
    </main>
</body>

<script>
    $(document).ready(function () {
        // Aplica máscaras
        $('#telefone').mask('(00) 00000-0000');
        $('#cep').mask('00000-000');

        // Captura o ID da URL
        const urlParams = new URLSearchParams(window.location.search);
        const idUsuario = urlParams.get('id');

        console.log('ID do usuário capturado:', idUsuario);

        if (!idUsuario) {
            Swal.fire({
                icon: 'error',
                title: 'Erro',
                text: 'ID do usuário não encontrado!'
            }).then(() => {
                window.location.href = 'listagem.html';
            });
            return;
        }

        // Busca os dados do usuário
        carregarDadosUsuario(idUsuario);

        // Função para carregar os dados do usuário
        function carregarDadosUsuario(id) {
            const token = localStorage.getItem('token');

            console.log('Token:', token ? 'Existe' : 'Não encontrado');
            console.log('URL da requisição:', `${ipPython}/usuario/${id}`);

            $.ajax({
                url: `${ipPython}/usuario/${id}`,
                type: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                success: function (response) {
                    console.log('Resposta completa da API:', response);

                    const usuario = response.usuario;
                    console.log('Dados do usuário:', usuario);
                    console.log('Cargo do usuário:', usuario.cargo);

                    // Salva o cargo em campo oculto
                    $('#cargo').val(usuario.cargo);

                    // Preenche os campos básicos
                    $('#nome').val(usuario.nome);
                    $('#email').val(usuario.email);
                    $('#telefone').val(usuario.telefone);
                    $('#cep').val(usuario.cep || '');

                    // Formata e preenche a data de nascimento
                    if (usuario.data_nascimento) {
                        let dataFormatada = usuario.data_nascimento;
                        console.log('Data recebida:', dataFormatada);

                        if (dataFormatada.includes('-')) {
                            const partes = dataFormatada.split('-');
                            if (partes[0].length === 2) {
                                dataFormatada = `${partes[2]}-${partes[1]}-${partes[0]}`;
                            }
                        }
                        console.log('Data formatada:', dataFormatada);
                        $('#data-nascimento').val(dataFormatada);
                    }

                    // Verifica se é fornecedor (cargo == 2)
                    if (usuario.cargo == 2) {
                        console.log('Usuário é FORNECEDOR - mostrando campos específicos');
                        $('#campos-fornecedor').show();

                        // Mostra o botão "Adicionar Serviço"
                        $('#btn-adicionar-servico').show();

                        // Define ação do botão para redirecionar e passar o ID do fornecedor
                        $('#btn-adicionar-servico').off('click').on('click', function () {
                            window.location.href = `../cadastro_servico_adm.html?id=${idUsuario}`;
                        });

                        // Preenche campos de fornecedor
                        $('#nome-marca').val(usuario.nome_marca || '');
                        if (usuario.categoria) {
                            $('#categoria').val(usuario.categoria);
                        }
                    } else {
                        console.log('Usuário NÃO é fornecedor - ocultando campos específicos');
                        $('#campos-fornecedor').hide();
                        $('#btn-adicionar-servico').hide();
                    }

                    console.log('Formulário preenchido com sucesso!');
                },
                error: function (xhr, status, error) {
                    console.error('Erro na requisição:', {
                        status: xhr.status,
                        statusText: xhr.statusText,
                        responseText: xhr.responseText,
                        error: error
                    });

                    Swal.fire({
                        icon: 'error',
                        title: 'Erro ao carregar dados',
                        text: xhr.responseJSON?.error || `Erro ${xhr.status}: Não foi possível carregar os dados do usuário`
                    });
                }
            });
        }

        // Evento de submit do formulário (atualizar dados)
        $('.botao-editar').click(function (e) {
            e.preventDefault();

            const cargo = $('#cargo').val();
            console.log('Cargo no submit:', cargo);

            // Validação específica para fornecedores
            if (cargo == 2) {
                const categoria = $('#categoria').val();
                const nomeMarca = $('#nome-marca').val().trim();

                console.log('Validando fornecedor - Categoria:', categoria, 'Nome Marca:', nomeMarca);

                if (!categoria || categoria === '') {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Campo obrigatório',
                        text: 'Por favor, selecione uma categoria para o fornecedor.'
                    });
                    return;
                }

                if (!nomeMarca) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Campo obrigatório',
                        text: 'Por favor, preencha o nome da marca do fornecedor.'
                    });
                    return;
                }
            }

            const token = localStorage.getItem('token');
            const formData = new FormData();

            formData.append('nome', $('#nome').val());
            formData.append('email', $('#email').val());
            formData.append('telefone', $('#telefone').val());
            formData.append('cep', $('#cep').val());

            if (cargo == 2) {
                formData.append('nome_marca', $('#nome-marca').val());
                formData.append('categoria', $('#categoria').val());
            }

            const dataNascimento = $('#data-nascimento').val();
            if (dataNascimento) {
                const partes = dataNascimento.split('-');
                const dataFormatada = `${partes[2]}-${partes[1]}-${partes[0]}`;
                formData.append('data_nascimento', dataFormatada);
            }

            console.log('Enviando atualização para:', `${ipPython}/usuarios/${idUsuario}`);

            $.ajax({
                url: `${ipPython}/usuarios/${idUsuario}`,
                type: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                data: formData,
                processData: false,
                contentType: false,
                success: function (response) {
                    console.log('Atualização bem-sucedida:', response);
                    Swal.fire({
                        icon: 'success',
                        title: 'Sucesso!',
                        text: 'Usuário atualizado com sucesso!'
                    }).then(() => {
                        window.location.href = 'listagem.html';
                    });
                },
                error: function (xhr) {
                    console.error('Erro ao atualizar:', xhr);
                    Swal.fire({
                        icon: 'error',
                        title: 'Erro ao atualizar',
                        text: xhr.responseJSON?.error || 'Não foi possível atualizar o usuário'
                    });
                }
            });
        });
    });

</script>

</html>