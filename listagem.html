<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Listagem de Usuários - Casamento Perfeito</title>
  <link rel="stylesheet" href="assets/css/listagem.css">
  <link rel="icon" href="assets/img/iconsite.png" type="image/x-icon">

  <!-- Sweet Alert -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

  <script src="api.js"></script>
</head>

<body style="background: url('assets/img/fundo-alianca.jpg')">
  <div class="overlay">
    <div class="modal">
      <img src="assets/img/logo-preta.png" alt="Logo Casamento Perfeito" class="logo-canto">
      <a href="home.html">
        <p class="close-btn">X</p>
      </a>
      <h2 class="titulo">Listagem de usuários</h2>

      <div class="lista">
        <!-- Cabeçalho -->
        <div class="lista-header">
          <div class="header-usuario">Usuário:</div>
          <div class="header-tipo">Tipo:</div>
          <div class="header-acao"></div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    document.addEventListener("DOMContentLoaded", async () => {
        const token = localStorage.getItem('token'); 

        if (!token) {
            // A biblioteca Swal precisa ser importada no <head> para funcionar
            Swal.fire({
                icon: 'warning',
                title: 'Acesso Restrito',
                text: 'Você precisa estar logado para acessar esta página.',
                confirmButtonText: 'Entendi, ir para Login',
                allowOutsideClick: false, // Impede que o usuário feche o modal clicando fora
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = 'login.html'; // Redireciona para o login
                }
            });

            return; 
        }

        const lista = document.querySelector(".lista");

        const tiposMap = {
            1: "Noivo",
            2: "Fornecedor",
            3: "Cerimonialista"
        };

        try {
            // Certifique-se de que a variável 'ipPython' está definida (provavelmente em api.js)
            const response = await fetch(`${ipPython}/usuario`, {
                headers: {
                    'Authorization': `Bearer ${token}` // É uma boa prática enviar o token para a API
                }
            });

            if (response.status === 401 || response.status === 403) {
                // Se o token for inválido, redireciona também
                throw new Error("Token inválido ou expirado.");
            }
            
            if (!response.ok) {
                throw new Error("Erro HTTP: " + response.status);
            }

            const data = await response.json();

            const header = document.querySelector(".lista-header");
            lista.innerHTML = "";
            lista.appendChild(header);

    // Cria os itens reais
    data.usuarios.forEach(u => {
      // Se não for 1,2 ou 3, será 'Adm'
      const tipoNome = tiposMap[u.cargo] || "Adm"; 
      const item = document.createElement("div");
      item.classList.add("item");
      item.innerHTML = `
        <a href="mailto:${u.email}">${u.email}</a>
        <span class="tipo">${tipoNome}</span>
        <button class="editar-btn" onclick="abrirEdicao(${u.id_usuario})">
          <img src="https://cdn-icons-png.flaticon.com/512/1159/1159633.png" alt="editar">
        </button>
      `;
      lista.appendChild(item);
    });

  } catch (error) {
    console.error("Erro ao carregar usuários:", error);
    const erroMsg = document.createElement("div");
    erroMsg.textContent = "Erro ao carregar usuários.";
    lista.appendChild(erroMsg);
  }
});

// Função para abrir a edição com o ID específico do usuário
function abrirEdicao(idUsuario) {
    if (idUsuario) {
        window.location.href = `edicao_usuarios_adm.html?id=${idUsuario}`;
    } else {
        console.error('ID do usuário não encontrado');
    }
}
</script>

</body>
</html>
